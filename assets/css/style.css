/* === [1. 기본 설정] === */
    * {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      -webkit-font-smoothing: antialiased;
      user-select: none; -webkit-user-select: none;
      -webkit-touch-callout: none;
      touch-action: none; /* 브라우저 기본 제스처 차단 */
    }
    
    body {
      margin: 0;
      background-color: #050505;
      background-image: radial-gradient(ellipse at center, #2c3e50 0%, #050505 60%);
      color: white;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex; align-items: center; justify-content: center;
    }

    .numeric-val { font-variant-numeric: tabular-nums; font-weight: 700; }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      background: #050505;
    }

    /* Aspect-fit surface that stays centered and letterboxed if needed */
    #game-surface {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #111;
      box-shadow: 0 10px 60px rgba(0, 0, 0, 0.9);
      overflow: hidden;
    }

    canvas { display: block; width: 100%; height: 100%; }

    /* === [모바일 컨트롤러 (전체 화면 덮개)] === */
    #mobile-controls {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 50; display: flex;
      /* 처음엔 숨김 (메뉴 화면) */
      display: none; 
    }

    /* 왼쪽: 이동 조이스틱 구역 */
    #joystick-zone {
      width: 50%; height: 100%; 
      position: relative; 
    }
    
    /* 조이스틱 UI */
    #joystick-base {
      width: 120px; height: 120px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      position: absolute;
      display: none; /* 기본: PC에서는 숨김, 터치 기기 anchor는 JS에서 제어 */
      opacity: 0.35;
      transition: opacity 0.15s, background 0.15s, border-color 0.15s, transform 0.15s;
      pointer-events: none; /* 터치 이벤트는 zone이 받음 */
    }
    #joystick-base.active{
      opacity: 0.95;
      background: rgba(255, 255, 255, 0.16);
      border-color: rgba(255, 255, 255, 0.5);
      transform: scale(1.02);
    }
    
    #joystick-stick {
      width: 50px; height: 50px;
      background: rgba(241, 196, 15, 0.9);
      border-radius: 50%;
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
      opacity: 0.45;
      transition: opacity 0.12s, box-shadow 0.12s;
    }
    #joystick-stick.active{
      opacity: 1;
      box-shadow: 0 0 20px rgba(241, 196, 15, 0.85);
    }

    /* 오른쪽: 대쉬 구역 */
    #dash-zone {
      width: 50%; height: 100%; 
      position: relative;
      display: flex; align-items: flex-end; justify-content: flex-end; 
      /* Safe Area: Add padding to the bottom and right */
      padding: 40px;
      padding-bottom: calc(40px + env(safe-area-inset-bottom, 0px));
      padding-right: calc(40px + env(safe-area-inset-right, 0px));
    }

    #btn-dash-visual {
      width: 90px; height: 90px;
      border-radius: 50%;
      background: rgba(231, 76, 60, 0.9); /* darker to replace removed blur */
      border: 3px solid rgba(231, 76, 60, 0.6);
      color: #e74c3c; font-weight: 900; font-size: 16px;
      display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 2px; position: relative;
      box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
      pointer-events: none;
      transition: transform 0.1s, background 0.1s;
    }
    /* 터치 시 반응 (JS로 클래스 토글) */
    #dash-zone.active #btn-dash-visual {
      background: rgba(231, 76, 60, 0.6);
      transform: scale(0.9);
      color: white;
    }

    /* DASH 쿨타임 표시 */
    #dash-cooldown-text{
      font-size: 14px;
      font-weight: 1000;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      opacity: 0.95;
      display: none;
    }
    #btn-dash-visual.not-ready{
      opacity: 0.45;
      filter: saturate(0.8);
    }
    #btn-dash-visual.not-ready #dash-cooldown-text{
      display: block;
    }

    /* [JFB v2] WAIT Phase - 회색/노란색 경고 */
    #btn-dash-visual.boost-wait {
      background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 50%, #bdc3c7 100%);
      border: 3px solid rgba(241, 196, 15, 0.7);
      color: #f1c40f;
      box-shadow: 0 0 15px rgba(241, 196, 15, 0.3);
      animation: boost-wait-pulse 0.8s ease-in-out infinite;
      opacity: 1 !important;
      filter: none !important;
    }
    #btn-dash-visual.boost-wait::after {
      content: 'WAIT';
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      font-weight: 900;
      color: #f1c40f;
      text-shadow: 0 0 6px rgba(241, 196, 15, 0.8);
      letter-spacing: 1px;
    }
    @keyframes boost-wait-pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }
      50% { transform: scale(1.02); box-shadow: 0 0 25px rgba(241, 196, 15, 0.5); }
    }
    #dash-zone.active #btn-dash-visual.boost-wait {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      transform: scale(0.92);
      animation: none;
    }

    /* [JFB v2] ACTIVE Phase - 강렬한 Cyan, 크기 확대, 글로우 */
    #btn-dash-visual.boost-active {
      background: linear-gradient(135deg, #00ffff 0%, #00e5ff 30%, #00bcd4 60%, #0097a7 100%);
      border: 4px solid rgba(0, 255, 255, 1);
      color: #ffffff;
      box-shadow:
        0 0 30px rgba(0, 255, 255, 0.9),
        0 0 60px rgba(0, 229, 255, 0.7),
        0 0 100px rgba(0, 188, 212, 0.5),
        inset 0 0 20px rgba(255, 255, 255, 0.3);
      animation: boost-active-pulse 0.15s ease-in-out infinite;
      opacity: 1 !important;
      filter: none !important;
      transform: scale(1.15);
      font-size: 14px;
      font-weight: 900;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    }
    #btn-dash-visual.boost-active::after {
      content: 'NOW!!';
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 13px;
      font-weight: 900;
      color: #00ffff;
      text-shadow: 0 0 12px rgba(0, 255, 255, 1);
      letter-spacing: 2px;
      animation: active-text-flash 0.2s infinite alternate;
    }
    @keyframes boost-active-pulse {
      0%, 100% {
        transform: scale(1.15);
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.9), 0 0 60px rgba(0, 229, 255, 0.7);
      }
      50% {
        transform: scale(1.20);
        box-shadow: 0 0 50px rgba(0, 255, 255, 1), 0 0 100px rgba(0, 229, 255, 0.9);
      }
    }
    @keyframes active-text-flash {
      from { opacity: 0.7; }
      to { opacity: 1; }
    }
    #dash-zone.active #btn-dash-visual.boost-active {
      background: linear-gradient(135deg, #0097a7 0%, #00ffff 100%);
      transform: scale(1.0);
      animation: none;
    }

    /* 토스트(짧은 피드백) */
    #toast-msg{
      position: absolute;
      top: 220px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 16px;
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 900;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s, transform 0.15s;
      z-index: 80;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }
    #toast-msg.show{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    #toast-msg.level-warn{ border-color: rgba(241, 196, 15, 0.5); }
    #toast-msg.level-danger{ border-color: rgba(231, 76, 60, 0.6); }
    /* 상태별 컨테이너 강조 */
    #game-container.state-stop,
    #game-surface.state-stop{ box-shadow: 0 0 60px rgba(231, 76, 60, 0.35); }
    #game-container.state-warning,
    #game-surface.state-warning{ box-shadow: 0 0 60px rgba(241, 196, 15, 0.25); }

    /* === [HUD UI] === */
    #hud {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 60;
    }

    /* HUD 아이콘 공통 */
    .hud-icon {
      width: 24px; height: 24px; object-fit: contain;
    }

    /* 좌측 상단: 점수/코인/보석 */
    .hud-left {
      position: absolute;
      /* Safe Area: Notch 대응 */
      top: calc(20px + env(safe-area-inset-top, 0px));
      left: calc(20px + env(safe-area-inset-left, 0px));
      display: flex; flex-direction: column; gap: 12px; align-items: flex-start;
    }

    .score-pill {
      background: rgba(0,0,0,0.9); /* darker to replace removed blur */
      padding: 8px 12px;
      border-radius: 25px;
      font-weight: 700;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      border: 2px solid rgba(255,255,255,0.3);
      min-width: 80px;
      line-height: 1;
    }

    .score-pill .numeric-val {
      display: flex;
      align-items: center;
      line-height: 1;
    }

    .score-pill.score-main {
      border-color: rgba(121, 245, 102, 0.5);
    }

    .score-green {
      color: #79F566;
      text-shadow: 0 0 8px rgba(121, 245, 102, 0.5);
      font-size: 22px;
      line-height: 1;
    }

    /* 통화 아이콘 스타일 */
    .currency-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
      vertical-align: middle;
    }

    .currency-icon-sm {
      width: 18px;
      height: 18px;
      object-fit: contain;
      vertical-align: middle;
    }

    .currency-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .result-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* 기존 score-display (숨김 처리용) */
    .score-display {
      display: none;
    }

    /* === [NEW] 버프 아이콘 컨테이너 (원형 아이콘) === */
    #buff-container {
      position: absolute;
      top: 200px;
      /* Safe Area: Notch 대응 */
      left: calc(20px + env(safe-area-inset-left, 0px));
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .buff-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: none; /* 기본 숨김 - 활성화 시 표시 */
      justify-content: center;
      align-items: center;
      border: 2px solid rgba(255,255,255,0.25);
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      animation: buff-pop-in 0.3s ease-out;
      transition: opacity 0.2s, transform 0.2s;
    }

    .buff-icon.active {
      display: flex;
    }

    .buff-icon img {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }

    #buff-barrier { background: rgba(52, 152, 219, 0.85); }
    #buff-booster { background: rgba(231, 76, 60, 0.85); }
    #buff-magnet { background: rgba(160, 76, 199, 0.85); }

    /* 버프 만료 경고 깜빡임 */
    .buff-icon.expiring {
      animation: buff-blink 0.3s infinite alternate;
    }

    .buff-icon.expiring-fast {
      animation: buff-blink-fast 0.15s infinite alternate;
    }

    @keyframes buff-pop-in {
      from { transform: scale(0.5); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes buff-blink {
      from { opacity: 1; }
      to { opacity: 0.4; }
    }

    @keyframes buff-blink-fast {
      from { opacity: 1; }
      to { opacity: 0.2; }
    }

    /* === [NEW] 중앙 상단: 색상 패널 === */
    #target-display {
      position: absolute;
      /* Safe Area: Notch 대응 */
      top: calc(26px + env(safe-area-inset-top, 0px));
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 120px;
      border: 6px solid rgba(255,255,255,0.4);
      border-radius: 12px;
      background-color: #222;
      box-shadow: 0 5px 25px rgba(0,0,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
    }

    #countdown-text {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Roboto', sans-serif; /* Changed font family */
      font-weight: 900;
      color: white;
      font-variant-numeric: tabular-nums;
      position: relative;
      top: -2px;
    }
    #countdown-text.countdown-is-number {
      font-size: 52px; /* Original large size for numbers */
    }
    #countdown-text.countdown-is-text {
      font-size: 32px; /* Slightly smaller size for text (GO/STOP) */
    }


    /* === [NEW] 상태 바 컨테이너 (중앙) === */
    #status-bar-container {
      position: absolute;
      /* Safe Area: Notch 대응 (target-display 아래에 위치하므로 간격 조정) */
      top: calc(160px + env(safe-area-inset-top, 0px));
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #status-bar-container #phase-bar {
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      width: 120px;
    }

    #status-bar-container #status-msg {
      position: relative;
      top: auto;
      left: auto;
      transform: none;
    }

    #status-msg {
      width: auto;
      height: auto;
      padding: 6px 14px;
      border-radius: 8px;
      background: rgba(0,0,0,0.9); /* darker to replace removed blur */
      border: 1px solid rgba(255,255,255,0.10);
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      font-weight: 900;
      text-shadow: 0 2px 4px rgba(0,0,0,0.75);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      pointer-events: none;
    }

    /* === [NEW] 우측 상단: 일시정지 버튼 === */
    .hud-pause-btn {
      position: absolute;
      /* Safe Area: Notch 대응 */
      top: calc(20px + env(safe-area-inset-top, 0px));
      right: calc(20px + env(safe-area-inset-right, 0px));
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(0,0,0,0.55);
      border: none;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: auto;
      z-index: 100;
    }

    .hud-pause-btn:active {
      background: rgba(255,255,255,0.2);
    }

    .pause-icon {
      display: flex;
      gap: 4px;
    }

    .pause-icon::before,
    .pause-icon::after {
      content: '';
      width: 5px;
      height: 18px;
      background: #D9D9D9;
      border-radius: 2px;
    }

    /* === [NEW] 우측: 스테이지 게이지 바 === */
    #chase-ui {
      position: absolute;
      /* Safe Area: Notch and side-screen compatibility */
      top: calc(79px + env(safe-area-inset-top, 0px));
      right: max(34px, env(safe-area-inset-right, 14px));
      width: 12px;
      height: 240px; /* 총 길이 240px */
    }

    #chase-bar {
      position: relative;
      width: 12px;
      height: 100%;
      background: rgba(0,0,0,0.18);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      overflow: visible;
    }

    /* 게이지 공통 스타일 */
    .chase-gauge {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 8px;
      height: 0%;
      border-radius: 4px;
      transition: height 0.15s linear;
    }

    /* 플레이어 게이지 (하단 레이어) */
    .player-gauge {
      background: linear-gradient(to top, #DCFF89 0%, rgba(220, 255, 137, 0.6) 100%);
      z-index: 5;
    }

    /* 스톰 게이지 (상단 레이어 - 플레이어를 가림) */
    .storm-gauge {
      background: linear-gradient(to top, #FF465F 0%, rgba(255, 70, 95, 0.5) 100%);
      z-index: 10;
    }

    /* 핀 마커 공통 */
    .chase-pin {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 32px;
      height: 32px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 15;
    }

    .chase-pin img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    /* 스톰 핀은 더 높은 z-index */
    .storm-gauge .chase-pin {
      z-index: 20;
    }

    /* 위험 모드 (스톰이 가까울 때) */
    #chase-ui.danger-mode #chase-bar {
      border-color: #e74c3c;
      box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
    }

    #chase-ui.danger-mode .storm-gauge {
      animation: storm-pulse 0.4s infinite alternate;
    }

    @keyframes storm-pulse {
      from { opacity: 0.8; }
      to { opacity: 1; }
    }

    /* 상단 단계 타이머 바 - 컨테이너 내부용 */
    #phase-bar {
      height: 14px;
      background: rgba(255,255,255,0.12);
      border: 2px solid rgba(255,255,255,0.18);
      border-radius: 999px;
      overflow: hidden;
      pointer-events: none;
    }

    #phase-bar-fill {
      height: 100%;
      width: 100%;
      background: rgba(46, 204, 113, 0.75);
      transform-origin: left center;
      transform: scaleX(1);
      transition: transform 0.08s linear, background 0.2s;
    }

    #theme-notify {
      position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
      font-size: 42px; font-weight: 900; color: #fff; opacity: 0; pointer-events: none;
      transition: opacity 0.5s; z-index: 50; text-align: center; width: 100%;
      text-shadow: 0 0 20px rgba(0,0,0,0.8);
    }
    #storm-warning {
      position: absolute; bottom: 180px; left: 0; width: 100%; text-align: center;
      color: #ff3838; font-weight: 900; font-size: 20px;
      animation: blink 0.4s infinite alternate; display: none; pointer-events: none;
    }
    @keyframes blink { from { opacity: 0.3; } to { opacity: 1; } }

    /* === [메뉴 & 상점] === */
    #menu-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(10, 10, 15, 0.98); display: flex; flex-direction: column; /* no blur */
      align-items: center; justify-content: flex-start; z-index: 100;
      /* 모바일 스크롤 허용 */
      overflow-y: auto;
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
      padding: 40px 0;
    }
    /* 메뉴 내부 요소들도 스크롤 제스처를 막지 않게 설정 */
    #menu-screen * {
      touch-action: pan-y;
    }
    .currency-row {
      display: flex; justify-content: center; gap: 25px; margin-bottom: 20px;
      background: rgba(255,255,255,0.05); padding: 12px 30px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1);
    }
    .currency-item { font-size: 20px; font-weight: 800; display: flex; align-items: center; gap: 8px; }

    .result-card {
      width: 85%;
      background: linear-gradient(145deg, rgba(46, 204, 113, 0.08), rgba(52, 152, 219, 0.08));
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 18px;
      box-shadow: 0 8px 28px rgba(0,0,0,0.35);
    }
    .result-total-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 18px; font-weight: 900; margin-bottom: 6px;
    }
    .result-title { color: #2ecc71; letter-spacing: 0.5px; }
    .result-high-row {
      display: flex; gap: 10px; align-items: center;
      font-weight: 800; color: #bdc3c7; margin-bottom: 10px;
    }
    .badge-new {
      background: linear-gradient(90deg, #f1c40f, #e67e22);
      color: #000;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .result-detail { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .detail-row { display: flex; justify-content: space-between; font-weight: 800; color: #ecf0f1; }
    .result-currency-row {
      display: flex; gap: 14px; flex-wrap: wrap;
      font-weight: 800; color: #ecf0f1;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 8px 10px;
    }

    .tab-container { display: flex; gap: 5px; margin-bottom: 0px; width: 85%; }
    .tab-btn {
      background: #2d3436; border: 1px solid #444; color: #b2bec3;
      padding: 12px 0; border-radius: 12px 12px 0 0; cursor: pointer;
      font-weight: bold; flex: 1; text-align: center; font-size: 14px;
      transition: background 0.2s;
    }
    .tab-btn.active { background: #34495e; color: white; border-bottom: 2px solid #34495e; }

    .shop-content {
      width: 85%; background: #34495e;
      border-radius: 0 0 15px 15px; padding: 20px; margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.1);
      min-height: 320px; max-height: 450px; overflow-y: auto;
      box-sizing: border-box;
    }

    .qa-content {
      width: 85%; background: #34495e;
      border-radius: 0 0 15px 15px; padding: 20px; margin-bottom: 25px;
      border: 1px solid rgba(255,255,255,0.1);
      min-height: 320px; max-height: none; height: auto; overflow-y: auto;
      box-sizing: border-box;
    }

    /* === [모바일 스크롤 허용] ===
       전역 touch-action:none 때문에 메뉴 탭(상점/QA/스킨) 스크롤이 막히는 문제를 해결.
       - shop-content는 세로 스크롤(pan-y) 허용
       - iOS 관성 스크롤 지원
    */
    .shop-content{
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    .qa-content{
      touch-action: pan-y;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
    }
    /* 스크롤 영역 내부 컨트롤(슬라이더 등)은 기본 터치 동작 허용 */
    .shop-content *{
      touch-action: auto;
    }

    .shop-content::-webkit-scrollbar { width: 6px; }
    .shop-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    .qa-content::-webkit-scrollbar { width: 6px; }
    .qa-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    /* 아이템 공통 스타일 */
    .upgrade-item, .setting-item, .skin-list-item {
      background: rgba(0,0,0,0.25); padding: 14px; margin-bottom: 10px; border-radius: 12px;
      box-sizing: border-box;
    }
    .upgrade-item { display: flex; justify-content: space-between; align-items: center; }
    .qa-group .setting-item { flex-direction: column; align-items: stretch; gap: 10px; padding: 12px 16px; background: rgba(255, 255, 255, 0.06); }
    .upgrade-name { font-size: 15px; font-weight: 800; display: block; color: #ecf0f1; margin-bottom: 4px; }
    .stat-preview { font-size: 12px; color: #2ecc71; margin-top: 4px; display: block; font-weight: 600; }
    
    .btn-common, .btn-buy {
      border: none; padding: 10px 14px; border-radius: 8px;
      font-weight: 900; font-size: 13px; cursor: pointer; color: #fff;
      box-shadow: 0 3px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
    }
    .btn-common { background: #2ecc71; color: #0b2b14; min-width: 80px; font-size: 14px; }
    .btn-buy { flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; }
    .btn-common:active, .btn-buy:active { transform: translateY(2px); box-shadow: none; }
    .btn-common.disabled, .btn-coin.locked { background: #7f8c8d; color: #bdc3c7; cursor: not-allowed; }
    
    /* 스킨 리스트 */
    .skin-list-item { display: flex; flex-direction: column; gap: 8px; border: 2px solid transparent; }
    .skin-list-item.equipped { border-color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
    .skin-header { display: flex; align-items: center; justify-content: space-between; }
    .skin-info-left { display: flex; align-items: center; gap: 10px; }
    .skin-preview { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    .skin-details { display: flex; flex-direction: column; }
    .skin-name { font-size: 15px; font-weight: 800; color: #ecf0f1; }
    .skin-rarity { font-size: 11px; font-weight: 800; text-transform: uppercase; margin-top: 2px; }
    .skin-desc { font-size: 12px; color: #bdc3c7; font-weight: 500; margin: 4px 0; }
    .skin-actions { display: flex; gap: 6px; width: 100%; }
    
    .rarity-Common { color: #b2bec3; }
    .rarity-Rare { color: #3498db; }
    .rarity-Epic { color: #9b59b6; }
    .rarity-Unique { color: #e67e22; }
    .rarity-Legendary { color: #f1c40f; text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }
    .rarity-Mystic { color: #e74c3c; text-shadow: 0 0 8px rgba(231, 76, 60, 0.7); animation: mystic-pulse 1s infinite alternate; }
    @keyframes mystic-pulse { from{opacity:0.8;} to{opacity:1;} }

    .btn-coin { background: #27ae60; } .btn-gem { background: #8e44ad; }
    .btn-equip { background: #f39c12; width: 100%; }
    .btn-equipped { background: #2c3e50; color: #95a5a6; cursor: default; width: 100%; box-shadow: none; }
    
    .start-btn { padding: 16px 70px; font-size: 26px; background: linear-gradient(to bottom, #3498db, #2980b9); border: none; border-radius: 50px; cursor: pointer; font-weight: 900; color: white; margin-top: 15px; box-shadow: 0 6px 0 #1c5980; }
    .start-btn:active { transform: translateY(6px); box-shadow: none; }

    /* QA 폰트 */
    .vol-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; color: #ecf0f1; font-weight: bold; font-size: 14px; width: 100%; }
    .val-display { color: #f1c40f; font-size: 14px; font-weight: 800; font-variant-numeric: tabular-nums; }
    input[type=range] { width: 100%; accent-color: #f1c40f; cursor: pointer; height: 6px; border-radius: 5px; background: rgba(0,0,0,0.3); margin: 5px 0; display: block; border: none; outline: none; }

    /* === [NEW] 화면 전환 시스템 === */
    .full-screen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: none; flex-direction: column; align-items: center;
      background: #050505; z-index: 100;
      overflow-y: auto; touch-action: pan-y;
      -webkit-overflow-scrolling: touch; padding: 30px 0;
    }
    .full-screen.active-screen, .full-screen[style*="display: flex"] { display: flex; }
    .full-screen * { touch-action: pan-y; }

    /* === [NEW] TITLE SCREEN === */
    #screen-title {
      justify-content: center; padding: 0;
      background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    }
    .title-content { text-align: center; animation: title-float 3s ease-in-out infinite; }
    @keyframes title-float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
    .game-logo {
      font-size: 48px; font-weight: 900; color: #fff; margin: 0;
      text-shadow: 0 0 30px rgba(52, 152, 219, 0.8), 0 4px 0 #1a5276;
      letter-spacing: -2px; font-style: italic;
    }
    .game-logo .accent { color: #e74c3c; }
    .touch-prompt {
      margin-top: 40px; font-size: 18px; color: #7f8c8d; font-weight: 700;
      animation: blink-slow 1.5s ease-in-out infinite;
    }
    @keyframes blink-slow { 0%,100%{opacity:0.4;} 50%{opacity:1;} }

    /* === [NEW] LOBBY SCREEN === */
    #screen-lobby { justify-content: space-evenly; padding: 20px 0 30px 0; }
    .screen-header {
      width: 100%; padding: 10px 20px; display: flex; justify-content: center; align-items: center;
    }
    .lobby-currency { margin: 0; padding: 10px 25px; }
    .lobby-center { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; padding-top: 60px; }
    /* 무대 컨테이너: 캐릭터가 이 안에서만 움직임 */
    .lobby-stage {
      position: relative;
      width: 100%;
      height: 180px;
      display: flex;
      justify-content: center;
      overflow: hidden;
      margin-bottom: 10px;
    }

    /* 일직선의 땅 (Neon Ground) */
    .lobby-ground {
      position: absolute;
      bottom: 20px;
      width: 120%;
      height: 2px;
      background: rgba(255, 255, 255, 0.5);
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.8), 0 0 5px #fff;
      border-radius: 50%;
    }

    /* 캐릭터 본체 */
    .lobby-char-box {
      position: absolute;
      bottom: 22px;
      left: 50%;
      transform: translateX(-50%);
      width: 110px; height: 110px;
      border-radius: 50%;
      background: #333;
      border: 4px solid #fff;
      box-shadow: 0 0 20px rgba(255,255,255,0.2);
      display: flex; justify-content: center; align-items: center;
      font-size: 55px;
      cursor: pointer;
      transition: left 1s ease-in-out, transform 0.2s;
      animation: char-idle 2s infinite ease-in-out;
      z-index: 5;
    }

    /* 숨쉬기 동작 */
    @keyframes char-idle {
      0%, 100% { transform: translateX(-50%) scale(1); }
      50% { transform: translateX(-50%) scale(1.05, 0.95); }
    }

    /* 점프 동작 */
    @keyframes char-jump {
      0% { bottom: 22px; transform: translateX(-50%) scale(1.2, 0.8); }
      40% { bottom: 120px; transform: translateX(-50%) scale(0.9, 1.1); }
      100% { bottom: 22px; transform: translateX(-50%) scale(1); }
    }
    .anim-jump { animation: char-jump 0.5s ease-out !important; }

    /* 걷는 동작 */
    .anim-walk { animation: char-walk 0.3s infinite alternate !important; }
    @keyframes char-walk {
      from { bottom: 22px; }
      to { bottom: 28px; }
    }
    .lobby-char-name { margin-top: 15px; font-size: 16px; font-weight: 800; color: #ecf0f1; cursor: pointer; }
    .lobby-loadout { text-align: center; margin: 20px 0; }
    .loadout-label { font-size: 12px; font-weight: 800; color: #7f8c8d; margin-bottom: 10px; letter-spacing: 2px; }
    .loadout-slots { display: flex; gap: 15px; justify-content: center; }
    .lobby-slot {
      width: 70px; height: 70px; border-radius: 12px;
      background: rgba(255,255,255,0.05); border: 2px dashed rgba(255,255,255,0.2);
      display: flex; justify-content: center; align-items: center; cursor: pointer;
      transition: all 0.2s;
    }
    .lobby-slot:hover, .lobby-slot:active { border-color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
    .lobby-slot.filled { border-style: solid; border-color: #3498db; background: rgba(52, 152, 219, 0.15); }
    .slot-icon { font-size: 28px; color: rgba(255,255,255,0.3); }
    .lobby-slot.filled .slot-icon { color: #fff; }
    .lobby-footer { display: flex; gap: 15px; align-items: center; padding: 0 20px; padding-bottom: 30px; }
    .btn-side {
      padding: 14px 20px; font-size: 14px; font-weight: 900; border: none; border-radius: 12px;
      background: #34495e; color: #ecf0f1; cursor: pointer; box-shadow: 0 4px 0 #2c3e50;
    }
    .btn-side:active { transform: translateY(4px); box-shadow: none; }
    .lobby-start { padding: 18px 40px; font-size: 22px; }

    /* === [NEW] SHOP/QA SCREEN HEADER === */
    #screen-shop .screen-header, #screen-qa .screen-header {
      justify-content: space-between; background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .btn-back {
      background: none; border: none; color: #3498db; font-size: 16px; font-weight: 800;
      cursor: pointer; padding: 8px 12px;
    }
    .header-title { font-size: 18px; font-weight: 900; color: #fff; }
    .header-currency { gap: 15px; font-size: 14px; font-weight: 800; background: none; padding: 0; border: none; }

    /* === [NEW] RESULT SCREEN === */
    #screen-result { justify-content: center; gap: 20px; }
    .result-header {
      font-size: 36px; font-weight: 900; color: #e74c3c;
      text-shadow: 0 0 20px rgba(231, 76, 60, 0.5);
      animation: result-header-pulse 2s ease-in-out infinite;
    }
    @keyframes result-header-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.9; transform: scale(1.02); }
    }
    #screen-result .result-card {
      width: 90%;
      max-width: 400px;
      margin: 0;
      position: relative;
      padding: 20px;
    }
    .result-footer { display: flex; gap: 15px; margin-top: 10px; }
    .result-btn { padding: 16px 35px; font-size: 18px; }

    /* Skip Button */
    .result-skip-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #bdc3c7;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    .result-skip-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
    .result-skip-btn.hidden { display: none; }

    /* Score Breakdown Table */
    .result-breakdown {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 12px;
    }
    .breakdown-row {
      display: grid;
      grid-template-columns: 28px 70px 50px 45px 1fr;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      border: 1px solid transparent;
      opacity: 0.4;
      transform: translateX(-10px);
      transition: all 0.3s ease-out;
    }
    .breakdown-row[data-status="active"] {
      opacity: 1;
      transform: translateX(0);
      border-color: rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
    }
    .breakdown-row[data-status="done"] {
      opacity: 1;
      transform: translateX(0);
    }
    .breakdown-row.counting {
      animation: row-counting 0.1s linear infinite;
    }
    @keyframes row-counting {
      0%, 100% { background: rgba(255,255,255,0.08); }
      50% { background: rgba(255,255,255,0.12); }
    }
    .breakdown-icon img { width: 22px; height: 22px; object-fit: contain; }
    .breakdown-label { font-size: 12px; font-weight: 700; color: #bdc3c7; text-transform: uppercase; }
    .breakdown-count { font-size: 14px; font-weight: 800; color: #fff; text-align: right; }
    .breakdown-mult { font-size: 11px; font-weight: 600; color: #7f8c8d; }
    .breakdown-score { font-size: 16px; font-weight: 900; text-align: right; }
    .score-green { color: #2ecc71; }
    .score-gold { color: #f1c40f; }
    .score-cyan { color: #00bcd4; }
    .score-white { color: #ecf0f1; }

    /* Divider */
    .result-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      margin: 12px 0;
    }

    /* Total Score */
    .result-total-value {
      font-size: 28px;
      color: #2ecc71;
      text-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
    }
    .result-total-value.counting {
      animation: total-pulse 0.15s ease-in-out infinite;
    }
    @keyframes total-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* High Score Section */
    .result-highscore-section {
      margin: 12px 0;
      text-align: center;
    }
    .highscore-bar-container {
      margin-bottom: 8px;
    }
    .highscore-bar-bg {
      height: 12px;
      background: rgba(0,0,0,0.4);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .highscore-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #3498db, #2ecc71);
      border-radius: 6px;
      transition: width 0.8s ease-out;
    }
    .highscore-bar-current {
      position: absolute;
      top: -2px;
      width: 4px;
      height: 16px;
      background: #fff;
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
      transition: left 0.8s ease-out;
      left: 0%;
    }
    .highscore-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      font-weight: 700;
      color: #7f8c8d;
      margin-top: 4px;
    }
    .badge-new {
      background: linear-gradient(90deg, #f1c40f, #e67e22);
      color: #000;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 900;
      box-shadow: 0 2px 10px rgba(241, 196, 15, 0.5);
      animation: badge-flash 0.5s ease-in-out infinite;
      display: inline-block;
    }
    @keyframes badge-flash {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.85; transform: scale(1.05); }
    }

    /* Score Guide Button */
    .score-guide-btn {
      position: absolute;
      bottom: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #bdc3c7;
      font-size: 14px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s;
    }
    .score-guide-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

    /* Score Guide Popup */
    .score-guide-popup {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 200;
    }
    .score-guide-content {
      background: #2c3e50;
      padding: 25px;
      border-radius: 16px;
      max-width: 300px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .score-guide-header {
      font-size: 20px;
      font-weight: 900;
      color: #fff;
      text-align: center;
      margin-bottom: 16px;
    }
    .score-guide-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-weight: 700;
      color: #ecf0f1;
    }
    .score-guide-item:last-of-type { border-bottom: none; }
    .guide-icon { width: 24px; height: 24px; object-fit: contain; }
    .guide-value { margin-left: auto; color: #2ecc71; }
    .score-guide-content .btn-common { margin-top: 15px; width: 100%; }

    /* === [NEW] PAUSE OVERLAY === */
    .overlay-popup {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.94); z-index: 150; /* darker to replace removed blur */
      display: flex; justify-content: center; align-items: center;
    }
    .pause-box {
      background: #2c3e50; padding: 30px 40px; border-radius: 20px;
      text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      border: 2px solid rgba(255,255,255,0.1);
    }
    .pause-title { font-size: 32px; font-weight: 900; color: #fff; margin-bottom: 25px; }
    .pause-btn { display: block; width: 100%; margin-bottom: 12px; padding: 14px 50px; font-size: 16px; }
    .pause-btn:last-child { margin-bottom: 0; }

    /* === [NEW] TREASURE LIST === */
    .treasure-item {
      background: rgba(0,0,0,0.25); padding: 14px; margin-bottom: 10px; border-radius: 12px;
      display: flex; justify-content: space-between; align-items: center;
      border: 2px solid transparent;
    }
    .treasure-item.owned { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
    .treasure-item.equipped { border-color: #f1c40f; background: rgba(241, 196, 15, 0.15); }
    .treasure-info { display: flex; flex-direction: column; gap: 4px; }
    .treasure-name { font-size: 15px; font-weight: 800; color: #ecf0f1; }
    .treasure-desc { font-size: 12px; color: #bdc3c7; }
    .treasure-actions { display: flex; gap: 8px; }

    /* === [FIX] QA 화면 높이 제한 해제 === */
    .qa-group {
      max-height: none !important;
      height: auto !important;
    }

/* === [MOBILE UI 조정] === */
@media screen and (max-width: 500px) {
  #target-display {
    top: calc(76px + env(safe-area-inset-top, 0px));
  }
  #status-bar-container {
    top: calc(210px + env(safe-area-inset-top, 0px)); /* Original: 160px */
  }
  #toast-msg {
    top: calc(270px + env(safe-area-inset-top, 0px)); /* Original: 220px */
  }
}
