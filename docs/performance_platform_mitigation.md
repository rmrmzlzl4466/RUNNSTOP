# 성능/발열/플랫폼 대응 개선안

## 목적
현재 구조 기준으로 성능 저하, 발열, 렉, 메모리 누수, 데이터 누적 위험을 점검하고, 적용 가능한 해결 방안을 단계별로 제시한다.

## 요약 결론
- 치명적인 누수/무한 누적 구조는 보이지 않음.
- 다만 저사양 모바일(iOS/Android)에서 발열 및 프레임 드랍 가능성이 있는 지점이 존재함.
- 즉시 적용 가능한 저위험 개선(디버그 렌더 차단, 이펙트 양 조절, 타이머 구조 정리)만으로도 체감 성능을 개선할 수 있음.

## 관찰된 리스크 (현 구조 기준)

### 1) 렌더링/그래픽 부담
- `assets/js/core/renderer.js`에서 `drawSlowMoEffects`가 항상 디버그 텍스트를 렌더링함.
  - 모바일에서는 불필요한 텍스트 렌더가 CPU/GPU 사용률 상승으로 이어질 수 있음.
- 폭풍 이펙트(`drawStorm`)가 프레임마다 랜덤 불꽃을 다수 생성/렌더링함.
  - 저사양 기기에서 발열 및 프레임 드랍 유발 가능.
- 아이템 렌더에서 그림자/글로우 연산이 상시 수행됨.
  - iOS에서 `shadowBlur`는 특히 비용이 큼.

### 2) 타이머/비동기 처리
- `assets/js/game/gimmick.js`의 `GLITCH_SWAP`는 타일 단위로 `setTimeout` 다중 생성.
  - WARNING 상태가 길어지면 타이머 수가 늘어나 GC/스케줄링 부담 가능.
- `assets/js/ui/debugOverlay.js`는 오버레이 활성 시 10Hz DOM 업데이트.
  - QA 중 사용 시 성능 저하 가능.

### 3) 데이터/메모리 누적 가능성
- 레벨 데이터(`LevelManager.rows`)는 `cleanupRows`로 정리됨.
- 아이템 배열(`runtime.items`)은 폭풍 뒤/플레이어 뒤에서 제거됨.
- 튜토리얼/결과 UI 타이머는 단발성이고 제거 로직 있음.
- 저장 데이터는 고정 키 로컬 저장이므로 무제한 증가는 아님.

=> 현재 상태로는 무한 누수보다는 프레임당 연산량과 타이머 폭증이 주요 리스크.

### 4) 플랫폼/화면 대응
- 캔버스 리사이즈 로직과 safe-area 처리는 있음.
- 다만 `assets/css/tutorial.css`는 고정 폰트/포지션 위주로 작은 화면/가로모드에서 겹침 여지가 있음.
- 일부 UI는 절대 위치+고정 px 사용이 많아 초소형 화면에서 겹침 가능.


## 해결 방안 (단계별)

### A. 즉시 적용 (저위험, 체감 개선 큼)
1) 디버그 텍스트 렌더 조건부 처리
- `assets/js/core/renderer.js`의 `drawSlowMoEffects`에 QA 플래그 추가.
- `qaConfig.showDebug = true`일 때만 디버그 텍스트 출력.
- 릴리스 모드에서는 항상 비활성.

2) 폭풍/이펙트 품질 자동 조절
- `smoothedFps` 기반 저품질 모드 확장.
- `drawStorm` 불꽃 개수/알파를 FPS에 따라 조정.
- 예: FPS < 52 이면 flameCount 절반.

3) 그림자/글로우 비용 절감
- iOS/저사양에서는 `shadowBlur = 0` 고정.
- 이미 iOS는 비활성화되어 있으나, 저FPS 시 추가로 끔.

4) WARNING 상태 타이머 폭증 억제
- `GLITCH_SWAP`의 `setTimeout` 대신, Map에 만료 시각 저장 후 매 프레임 정리 방식으로 교체.
  - 타이머 수 급증 방지.


### B. 중기 적용 (구조 개선 포함)
1) 이펙트 품질 레벨 추가
- `qaConfig.visualQuality = 'high|med|low'` 도입.
- 렌더링/이펙트/파티클/글로우 범위 조절.

2) 타이머/애니메이션 관리 일원화
- UI 애니메이션(결과 화면 등) 타이머를 하나의 큐로 관리.
- 화면 전환 시 타이머 취소 가능하도록 관리 모듈 추가.

3) 아이템/타일 렌더 범위 줄이기
- 현재는 화면보다 넓은 범위를 렌더링.
- `cameraZoom`에 따라 추가 row 수를 더 보수적으로 계산.


### C. 장기 적용 (플랫폼 안정성 강화)
1) 저사양 모드 자동 전환
- 평균 FPS/프레임 타임 기반으로 자동 저사양 모드 전환.
- 모드 전환 시 오버레이, 글리치, 글로우 효과 비활성.

2) UI 반응형 보강
- `assets/css/tutorial.css`에 media query 추가.
- 작은 화면에서 폰트 축소, 메시지 위치 조정.
- 가로모드에서 HUD 간격 조정.

3) 성능 프로파일링 장치 내장
- 간단한 FPS/아이템 수/rows 수 표시 토글 제공.
- QA 환경에서만 활성화.


## 구체 개선 제안 (파일별)

- `assets/js/core/renderer.js`
  - 디버그 텍스트 출력은 QA 모드에서만.
  - `drawStorm` 불꽃 수를 FPS 기반으로 조정.
  - 저사양 모드에서는 shadow/glow 비활성.

- `assets/js/game/gimmick.js`
  - GLITCH_SWAP 타이머 구조를 만료 시간 기반 정리 방식으로 변경.

- `assets/js/ui/debugOverlay.js`
  - 업데이트 간격을 FPS/저사양 상태에 따라 자동 느리게.

- `assets/css/tutorial.css`
  - 모바일/가로모드 대응 media query 추가.


## 검증 체크리스트
- 저사양 Android (3~4년 전 기기)에서 2분 이상 플레이 시 FPS 유지 여부.
- iOS Safari에서 발열/프레임 드랍/입력 지연 체감 확인.
- DEBUG 모드 off 상태에서 렌더링 오버헤드 제거 확인.
- 가로모드/소형 화면에서 HUD 겹침 여부 확인.


## 추천 우선순위
1) 디버그 렌더 차단 + 폭풍 이펙트 품질 조절
2) GLITCH_SWAP 타이머 구조 교체
3) UI 반응형 보강

---
작성: Codex
